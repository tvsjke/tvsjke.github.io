<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://unpkg.com/react@15/dist/react.js"></script>
	<script src="https://unpkg.com/react-dom@15/dist/react-dom.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.24/browser.js"></script>
	<link rel="stylesheet" type="text/css" href="css/styles.css">
	<title>Document</title>
</head>
<body>
	
	<div id="content"></div>

	<script type="text/babel">

		var localStorageGet = function(key) {
			return JSON.parse(localStorage.getItem(key));
		};

		var localStorageAdd = function(key, value) {
			var jsonArray = JSON.parse(localStorage.getItem(key));
			var lastID = 0;
			jsonArray.forEach(function(item) {
				if(item.id > lastID) lastID = item.id;
			});
			value.id = lastID + 1;
			jsonArray.push(value);
			localStorage.setItem(key, JSON.stringify(jsonArray));
		};

		var localStorageDelete = function(key, id) {
			var jsonArray = JSON.parse(localStorage.getItem(key));
			var jsonArray = jsonArray.filter(function(item) {
			    return item.id !== +id;
			});
			localStorage.setItem(key, JSON.stringify(jsonArray));
		};

		var TASKS = JSON.parse(localStorage.getItem("userTasks"));

		var Task = React.createClass({
			render: function() {
				return 	<div key="{this.props.key}" className="task">							
							<div className="task-info">
								<div className="task-description"> {this.props.description} </div>
								<div onClick={this.props.removeTask} className="task-remove"></div>
							</div>
						</div>;
			}
		});

		var Add = React.createClass({

			handleAdd: function() {
				$('.newtask-info').toggle();
			},

			handleSave: function() {
				

			},

			render: function() {
				return (
					<div>
						<div className="task-add" onClick={this.handleAdd}>{this.props.name}</div>
						<div className="newtask-info">
							<textarea rows="4" className="newtask-description"></textarea>
							<button onClick={this.props.addTask}>Добавить</button>
						</div>
						
					</div>
				)
			}
		});

		var TasksList = React.createClass({
			
			getInitialState: function() {
				return {
					displayedTasks: TASKS
				};
			},

			AddTask: function() {

				var task = $('.newtask-description').val();
				
				var obj = {
					description: task
				};

				localStorageAdd('userTasks', obj);

				$('.newtask-description').val('');

				TASKS = localStorageGet('userTasks');
				
				 this.setState({
					displayedTasks: TASKS
				})
			},

			RemoveTask: function(id) {

				localStorageDelete('userTasks', id);

				TASKS = localStorageGet('userTasks');
				
				this.setState({
					displayedTasks: TASKS
				})
			},
	
			handleSearch: function(e) {
				var searchQuery = e.target.value.toLowerCase();
				var displayedTasks = TASKS.filter(function(el) {
					var searchValue = el.description.toLowerCase();
					return searchValue.indexOf(searchQuery) !== -1;
				});

				this.setState({
					displayedTasks: displayedTasks
				});
			},

			render: function() {
				var self = this;

				return (
					<div className="tasks">
						<input type="text" className="search-field" onChange={this.handleSearch} />
						<Add addTask={this.AddTask} name="+" /> 
						<div className="tasks-list">
							{		
								!$.isEmptyObject(this.state.displayedTasks) ? 
									this.state.displayedTasks.map(function(el) {									
										return <Task 
											key={el.id} 
											name={el.name}
											description={el.description}
											removeTask={self.RemoveTask.bind(self, el.id)}/>;
									})
								 : false
							}
						</div>
					</div>
				)
			}
		})

		ReactDOM.render(
		    <TasksList />, document.getElementById('content')
		);

		var Timer = React.createClass({

			getInitialState: function() {
				return {
					timer: new Date()
				};
			},

			componentDidMount() {
			    this.timer = setInterval(
			       () => this.tick(),
			       1000
			    );
			},

			tick: function() {
				this.setState({
					timer: new Date()
				})
			},

		    render: function () {
		        return (
		            <div>
		                <p>The time is {this.state.timer.toLocaleTimeString()}</p>
		            </div>
		        )
		    }
		});

		/*ReactDOM.render(
		    <Timer />, document.getElementById('timer')
		);*/
		
				
	</script>

</body>
</html>
